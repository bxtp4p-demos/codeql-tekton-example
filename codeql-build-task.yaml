apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: codeql-build-task
spec:
  workspaces:
  - name: source
  steps:
  - name: build
    image: ubuntu
    script: |
      #!/bin/sh
      
      echo "Installing Java"
      apt update
      apt upgrade
      apt-cache search openjdk-17
      apt -y install openjdk-17-jdk openjdk-17-jre wget

      echo "Installing CodeQL CLI"
      wget https://github.com/github/codeql-action/releases/latest/download/codeql-bundle-linux64.tar.gz -O ../codeql-bundle-linux64.tar.gz
      tar xzvf ../codeql-bundle-linux64.tar.gz -C /opt/
      rm ../codeql-bundle-linux64.tar.gz
      export PATH=/opt/codeql:$PATH

      echo "Initializing CodeQL"
      codeql database init --source-root $(workspaces.source.path)  --language=java --begin-tracing /java-db
      . /java-db/temp/tracingEnvironment/start-tracing.sh

      echo "Building project"
      cd $(workspaces.source.path)
      ./mvnw clean package -DskipTests=true

      echo "Finalize CodeQL Database"
      codeql database finalize /java-db

      echo "Analyze CodeQL Database"
      mkdir ./temp
      codeql database analyze /java-db java-security-and-quality.qls --format=sarif-latest --output=./temp/results-java.sarif

      echo "Uploading SARIF results"
      codeql github upload-results --sarif=./temp/results-java.sarif --github-auth-stdin --github-url=https://github.com/ --repository=bxtp4p-demos/codeql-tekton-example"
